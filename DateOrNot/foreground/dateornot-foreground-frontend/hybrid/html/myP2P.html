<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title></title>
	<!-- å¾®ä¿¡ JS-SDK  -->
	<script type="text/javascript" src="//res.wx.qq.com/open/js/jweixin-1.4.0.js"></script> 
	<!-- uni çš„ SDK -->
	<script type="text/javascript" src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"></script>
	<!-- vueå¼€å‘ç¯å¢ƒç‰ˆæœ¬ï¼ŒåŒ…å«äº†æœ‰å¸®åŠ©çš„å‘½ä»¤è¡Œè­¦å‘Š -->
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>
	<div id='container' class="container">
		<div class="video-box" id="video-box">
			<video id="remote-video" autoplay></video>
			<video id="local-video"  muted autoplay></video>
			<!-- <button class="start-button" onclick="">start</button> -->
		</div>
		<image id='closeBut' class="closeBut" src="../../static/images/message/closeTalk.png" ></image>
	</div>
	<script>
		 new Vue ({
			el:'#container',
		    data:{
				target:'',
				localVideo: "æœ¬åœ°è§†é¢‘çª—",
				remoteVideo: "è¿œç¨‹è§†é¢‘çª—",
				agent:'',
				
				socketTask:null,
				socketIsOpen:false,
				socketUrl:"ws://119.23.49.121:8081/ws?uid=",
				
				webRTCisOpen:false,
				peer:'',
				stream:'',
				ice:'',
		    },
		    mounted() {
				this.localVideo=document.querySelector('#local-video');
				this.remoteVideo=document.querySelector('#remote-video');
				this.agent = this.urlParamGet(window.location.href);
				this.target = this.agent.type;
				if(Number(this.agent.uid)<=7000000){
					this.agent.uid = Number(this.agent.uid)+7000000;
				}
				this.socketIsOpen = false;
				this.socketUrl = this.socketUrl+this.agent.uid;
				console.log(this.socketUrl);
				// å¾…è§¦å‘ `UniAppJSBridgeReady` äº‹ä»¶åï¼Œå³å¯è°ƒç”¨ uni çš„ APIã€‚
				document.addEventListener('UniAppJSBridgeReady', function() {
				    uni.postMessage({
				        data: {
				            action: 'message',
				        }
				    });
				});
				let that = this;
				//ç»‘å®šæŒ‚æœºäº‹ä»¶
				document.querySelector('.closeBut').addEventListener('click', function(evt){
					that.sendMessage("ğŸ“ æ‹’ç»é€šè¯");
					uni.navigateTo({
					    url: '/pages/message/friendChat?id='+(Number(that.agent.accepter)-7000000)
					});
					that.freeResource(); //é‡Šæ”¾èµ„æº
				});
				//åˆå§‹åŒ–websocket
				this.WebSocketInit();
				//åˆå§‹åŒ–webrtc
				this.peerConnectionInit();
				
				this.localVideo.onloadeddata = () => {
					console.log('æ’­æ”¾æœ¬åœ°è§†é¢‘');
					this.localVideo.play();
					
				}
				this.remoteVideo.onloadeddata = () => {
					console.log('æ’­æ”¾å¯¹æ–¹è§†é¢‘');
					this.remoteVideo.play();
				}
			},
			beforeDestroy() {
				//å…³é—­websocket
				this.socketTask.close();
				this.freeResource(); //é‡Šæ”¾èµ„æº
			},
			watch:{
				socketIsOpen(val){
					if(val==true&&this.webRTCisOpen==false){
						if(this.target==='offer'){
							console.log("å¼€å§‹è¿æ¥");
							this.startLive();
						}else if(this.target==='answer'){
							console.log("å‘èµ·é€šè¯è¯·æ±‚");
							this.sendMessage("ğŸ“ è§†é¢‘é€šè¯");
						}
					}
				}
			},
		    methods: {
				//å†…ç½‘ç©¿é€æœåŠ¡å™¨é…ç½®ï¼Œçªç ´å±€åŸŸç½‘è§†é¢‘é€šè¯
				iceNetPassInit:function(){
					var ice = {"iceServers": [
					    {"url": "stun:stun.l.google.com:19302"},  // æ— éœ€å¯†ç çš„stunæœåŠ¡å™¨
					    // TURN ä¸€èˆ¬éœ€è¦è‡ªå·±å»å®šä¹‰
					    {
					      'url': 'turn:192.158.29.39:3478?transport=udp',
					      'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=', // å¯†ç 
					      'username': '28224511:1379330808' // ç”¨æˆ·å
					    },
					    {
					      'url': 'turn:192.158.29.39:3478?transport=tcp',
					      'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					      'username': '28224511:1379330808'
					    }
					  ]};
					return ice;
				},
				//å»ºç«‹websocketè¿æ¥
				WebSocketInit:function(){
					console.log("å°è¯•å»ºç«‹websocketè¿æ¥");
					//é˜²æ­¢é‡å¤è¿æ¥
					if(this.socketIsOpen){return}
					//è¿æ¥websocket
					this.socketTask = new WebSocket(this.socketUrl);
					//ç›‘å¬å¼€å¯
					this.socketTask.onopen=()=>{
						console.log("websocketå·²è¿æ¥");
						this.socketIsOpen = true;
					};
					//ç›‘å¬å…³é—­
					this.socketTask.onclose=()=>{
						console.log("è¿æ¥å·²å…³é—­");
						this.socketIsOpen = false;
					};					
					//ç›‘å¬é”™è¯¯
					this.socketTask.onerror=()=>{
						console.log("å‡ºé”™äº†");
						this.socketIsOpen = false;
					};					
					//ç›‘å¬æ¶ˆæ¯
					this.socketTask.onmessage=(e)=>{
						let msg = JSON.parse(e.data).msg;
						console.log('è§†é¢‘é€šè¯å®¢æˆ·ç«¯æ”¶åˆ°ï¼š'+msg);
						if(msg=="ğŸ“ æ‹’ç»é€šè¯"){
							this.closeChat();	//è°ƒç”¨é€šè¯ç»“æŸå¤„ç†
						}else{
							this.handShake(msg);	//è°ƒç”¨æ¡æ‰‹å¤„ç†
						}
					};
				},
				//å‘é€æ¶ˆæ¯
				sendMessage:function(mes){
					let data = {
						senderId: this.agent.uid, //ç”¨æˆ·id
						senderName: this.agent.uname,
						senderUrl: this.agent.headUrl,
						accepterId: this.agent.accepter,
						msg: mes,
						isChat: false,
						type: 'phone',
						time: new Date(),
					};
					if(Number(this.agent.accepter)<=7000000){
						this.agent.accepter = Number(this.agent.accepter)+7000000;
					}
					data = JSON.stringify(data);
					console.log("å°è¯•å‘é€æ¶ˆæ¯ï¼š"+data);
					if(this.socketIsOpen){
						this.socketTask.send(data);
					}
				},
				//åˆå§‹åŒ–p2pè¿æ¥
				peerConnectionInit:function(){
					var pcConfig = {
					    "iceServers": [
					        {
					          "urls": [
					            "stun:64.233.188.127:19302",
					            "stun:[2404:6800:4008:c06::7f]:19302"
					          ]
					        },
					        {
					          "urls": [
					            "turn:64.233.188.127:19305?transport=udp",
					            "turn:[2404:6800:4008:c06::7f]:19305?transport=udp",
					            "turn:64.233.188.127:19305?transport=tcp",
					            "turn:[2404:6800:4008:c06::7f]:19305?transport=tcp"
					          ],
					          "username": "CLmyo/MFEgYo3mLt4vIYzc/s6OMTIICjBQ",
					          "credential": "iqHMgEtiki1Mh7hFI4yaKJHLrz4=",
					          "maxRateKbps": "8000"
					        }
					      ]
					};
					var ICE_config= {
					  'iceServers': [
					    {
					      'url': 'stun:stun.l.google.com:19302'
					    },
					    {
					      'url': 'turn:192.158.29.39:3478?transport=udp',
					      'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					      'username': '28224511:1379330808'
					    },
					    {
					      'url': 'turn:192.158.29.39:3478?transport=tcp',
					      'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					      'username': '28224511:1379330808'
					    }
					  ]
					};
					var ic_config = {
						'iceServers':[
							{url:'stun:stun01.sipphone.com'},
							{url:'stun:stun.ekiga.net'},
							{url:'stun:stun.fwdnet.net'},
							{url:'stun:stun.ideasip.com'},
							{url:'stun:stun.iptel.org'},
							{url:'stun:stun.rixtelecom.se'},
							{url:'stun:stun.schlund.de'},
							{url:'stun:stun.l.google.com:19302'},
							{url:'stun:stun1.l.google.com:19302'},
							{url:'stun:stun2.l.google.com:19302'},
							{url:'stun:stun3.l.google.com:19302'},
							{url:'stun:stun4.l.google.com:19302'},
							{url:'stun:stunserver.org'},
							{url:'stun:stun.softjoys.com'},
							{url:'stun:stun.voiparound.com'},
							{url:'stun:stun.voipbuster.com'},
							{url:'stun:stun.voipstunt.com'},
							{url:'stun:stun.voxgratia.org'},
							{url:'stun:stun.xten.com'},
							{
								url: 'turn:numb.viagenie.ca',
								credential: 'muazkh',
								username: 'webrtc@live.com'
							},
							{
								url: 'turn:192.158.29.39:3478?transport=udp',
								credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
								username: '28224511:1379330808'
							},
							{
								url: 'turn:192.158.29.39:3478?transport=tcp',
								credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
								username: '28224511:1379330808'
							}
						]
					};
					const PeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
					this.peer = new RTCPeerConnection(ic_config);
					console.log('peeråˆå§‹åŒ–æˆåŠŸ');
					//ç›‘å¬æ•°æ®
					this.peer.ontrack = e => {
						console.log("rtcæ”¶åˆ°æ•°æ®"+e);
						if (e && e.streams) {
							console.log('æ”¶åˆ°å¯¹æ–¹éŸ³é¢‘/è§†é¢‘æµæ•°æ®...');
							this.remoteVideo.srcObject = e.streams[0];
						}
					};
					//ç›‘å¬å€™é€‰è€…
					this.peer.onicecandidate = e => {
						if (e.candidate) {
							console.log('æœé›†å¹¶å‘é€å€™é€‰äºº');
							this.sendMessage(JSON.stringify({
								type: this.target+`_ice`,
								iceCandidate: e.candidate
							}));
						} else {
							console.log('å€™é€‰äººæ”¶é›†å®Œæˆï¼');
						}
					};
				},
				//å¤„ç†urlå‚æ•°
				urlParamGet:function(url){
					 //å»æ‰ï¼Ÿ,è§£ç ç‰¹æ®Šå­—ç¬¦
					var arr= decodeURIComponent(url.split("?")[1]) ;
					//æ ¹æ®â€œ&â€åˆ†å‰²å­—ç¬¦ä¸²
					arr=arr.split("&");
					//å®šä¹‰ç©ºçš„paramsï¼Œä¿å­˜å¯¹è±¡
					var params={};
					//å¾ªç¯éå†åˆ†å‰²åçš„æ•°ç»„         
					for(var p of arr){
					   //æ ¹æ®â€œ=â€åˆ†å‰²
					  var arr2=p.split("=");
					  //è§£æ„
					  var [name,value]=arr2;
					  //å¦‚æœparamsä¸­çš„nameä¸ºundefinedå°±æŠŠå€¼å¡«è¿›å»
					  if(params[name]==undefined){
					      params[name]=value;
					  }
					}
					console.log(JSON.stringify(params));
					return params;         
				},
				//å¼€å¯é€šè¯
				async startLive(sdp){
					try {
						console.log('å°è¯•è°ƒå–æœ¬åœ°æ‘„åƒå¤´/éº¦å…‹é£');
						window.navigator.getUserMedia = navigator.getUserMedia || navigator.webKitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
						this.stream = await navigator.mediaDevices.getUserMedia({ "audio":true,"video":true });
						console.log('æ‘„åƒå¤´/éº¦å…‹é£è·å–æˆåŠŸï¼');
						if ("srcObject" in this.localVideo) {
						    this.localVideo.srcObject = this.stream
						} else {
						    this.localVideo.src = window.URL && window.URL.createObjectURL(this.stream) || this.stream
						}
						// å°†åª’ä½“è½¨é“æ·»åŠ åˆ°é€šé“ä¸­
						this.stream.getTracks().forEach(track => {
							console.log("å°†åª’ä½“è½¨é“æ·»åŠ åˆ°é€šé“ä¸­");
							this.peer.addTrack(track, this.stream);
						});
					} catch {
						console.error('æ‘„åƒå¤´/éº¦å…‹é£è·å–å¤±è´¥ï¼');
						return;
					}
					if (!sdp) {
						console.log('åˆ›å»ºæœ¬åœ°SDP');
						const offer = await this.peer.createOffer();
						await this.peer.setLocalDescription(offer);
						console.log(`ä¼ è¾“å‘èµ·æ–¹æœ¬åœ°SDP`);
						this.sendMessage(JSON.stringify(offer));
					} else {
						console.log('æ¥æ”¶åˆ°å‘é€æ–¹SDP');
						await this.peer.setRemoteDescription(sdp);
					
						console.log('åˆ›å»ºæ¥æ”¶æ–¹ï¼ˆåº”ç­”ï¼‰SDP');
						const answer = await this.peer.createAnswer();
						console.log(`ä¼ è¾“æ¥æ”¶æ–¹ï¼ˆåº”ç­”ï¼‰SDP`);
						this.sendMessage(JSON.stringify(answer));
						await this.peer.setLocalDescription(answer);
					}
					//æ˜¾ç¤ºç”»é¢
					var videoBox = document.querySelector('#video-box');
					videoBox.style.display='block';
					console.log(window.screen.width);
					videoBox.style.width=window.screen.availWidth +'px';
					videoBox.style.height=window.screen.availHeight+'px';
				},
				//æ¡æ‰‹å¤„ç†
				handShake:function(msg){
					const { type, sdp, iceCandidate } = JSON.parse(msg)
					if (type === 'answer') {
						console.log("æ”¶åˆ°answer");
						this.webRTCisOpen = true;
						this.peer.setRemoteDescription(new RTCSessionDescription({ type, sdp }));
					} else if (type === 'answer_ice') {
						console.log("æ”¶åˆ°answer_ice");
						this.peer.addIceCandidate(iceCandidate);
					} else if (type === 'offer') {
						console.log("æ”¶åˆ°offer");
						this.webRTCisOpen = true;
						this.startLive(new RTCSessionDescription({ type, sdp }));
					} else if (type === 'offer_ice') {
						console.log("æ”¶åˆ°offer_ice");
						this.peer.addIceCandidate(iceCandidate);
					}
				},
				//ç»“æŸé€šè¯é¡µé¢è¿”å›å¤„ç†
				closeChat:function(){
					if(Number(this.agent.accepter)>7000000){
						this.agent.accepter = Number(this.agent.accepter)-7000000;
					}
					console.log('è¿”å›åˆ°ï¼š/pages/message/friendChat?id='+this.agent.accepter);
					uni.navigateTo({
					    url: '/pages/message/friendChat?id='+this.agent.accepter
					});	
					this.freeResource(); //é‡Šæ”¾èµ„æº	
				},
				//èµ„æºé‡Šæ”¾å¤„ç†
				freeResource:function(){
					//å…³é—­websocketè¿æ¥
					if(this.socketIsOpen){
						this.socketIsOpen = false;
						this.socketTask.close();
					}
					//é‡Šæ”¾è§†é¢‘æµ
					if(this.stream!=null){
						this.stream&&this.stream.getTracks().forEach(track => {
							console.log("é‡Šæ”¾è§†é¢‘/éŸ³é¢‘æµ");
							track.stop();
						});
						this.stream = null;
					}
					//é‡Šæ”¾webRTCè¿æ¥
					if(null!=this.peer){
						this.peer.close();
						this.peer = null;
					}
				}
			}
		});
	</script>
	<style>
		body{
			background:url(../../static/images/message/background2.png)  no-repeat center center;
			background-size:cover;
			background-attachment:fixed;
		}
		.container {
			width: 100%;
			display: flex; 
			/* display: -webkit-flex; */
			/* justify-content: space-around; */
		}
		.video-box {
			width: 100%;
			height: 100%;
			position: relative;
			display: none;
		}
		#remote-video {
			width: 100%;
			height: 100%;
			display: block;
			object-fit: cover;
			/* border: 1px solid #eee; */
			/* background-color: #F2F6FC; */
		}
		#local-video {
			position: absolute;
			right: 0;
			top: 0;
			width: 40%;
			height: 25%;
			object-fit: cover;
			border: 1px solid #eee;
			background-color: #EBEEF5;
			/* é•œåƒç¿»è½¬ */
			transform: rotateY(180deg);
			-webkit-transform: rotateY(180deg);
			-moz-transform: rotateY(180deg);        
		}
		.closeBut{
			position: absolute;
			left: 40%;
			bottom: 5%;
			width: 20%;
			z-index: 999;
		}
	</style>
</body>
</html>